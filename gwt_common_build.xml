<!--===========================================================================
    GWT_COMMON_BUILD.XML
    
    This is the build file that is used across all GWT-based Pentaho projects.
    It is based on COMMON_BUILD.XML which is imported by this file. 
============================================================================-->
<project name="Pentaho GWT Common Build" basedir="." default="jar" xmlns:ivy="antlib:org.apache.ivy.ant">

  <description>
    This is the common build for Pentaho GWT projects
  </description>

  <!-- Define the default location of the common build file -->
  <property name="common.build.file"
            value="./common_build.xml"
            description="This is the location of the standardized common_build.xml file" />

  <!-- Import the common_build.xml file which contains all the default tasks -->
  <import file="${common.build.file}" />

  <property name="gwt.output.dir"
            value="${bin.dir}/gwt/output"
            description="Base directory that holds all gwt generated files" />
  <property name="gwt-dev.revision" value="1.5.2" description="The release of GWT-dev to download and install" />
  <property name="gwt-log-level" value="INFO" description="The log level for GWT Compile" />
  <property name="gwt-dev.zipfile"
            value="${devlib.dir}/gwt-dev-libs.zip"
            description="The download location of the GWT-dev zip file" />
  <property name="gwt-dev.jarfile"
            value="${devlib.dir}/gwt-dev-${gwt-dev.revision}.jar"
            description="The download location of the GWT-dev jar file" />
  <property name="gwt.artifact.id" value="${ivy.artifact.id}" description="The name of the GWT package artifact" />


  <!--=======================================================================
      resolve (override)
      
      Override to include resolution of IVY codegen and runtime configurations
      ====================================================================-->
  <target name="resolve" depends="resolve-codegen,resolve-runtime" description="Resolves all IVY configurations">
    <ant antfile="${common.build.file}" target="resolve" />
  </target>


  <!--=======================================================================
      resolve-codgen (override)
      
      Override to use OS-specific IVY configurations
      ====================================================================-->
  <target name="resolve-codegen" depends="resolve-init" description="Resolves all OS-specific codegen configurations">
    <ivy:resolve file="ivy.xml" conf="codegen-${os.classifier}" />
    <ivy:retrieve conf="codegen-${os.classifier}" pattern="${lib.dir}/[module]-[revision].[ext]" />
  </target>


  <!--=======================================================================
      gwt-compile
      
      Performs GWT Compile which generates JavaScript
      ====================================================================-->
  <target name="gwt-compile" description="Perform GWT Compile">
    <java classname="com.google.gwt.dev.GWTCompiler" fork="true" maxmemory="512M">
      <classpath>
        <path refid="classpath" />
        <pathelement path="${src.dir}" />
      </classpath>
      <arg value="-out" />
      <arg value="${gwt.output.dir}" />
      <arg value="%*" />
      <arg value="${gwt-module.path}" />
      <arg value="-logLevel" />
      <arg value="${gwt-log-level}" />
    </java>
  </target>


  <!--=======================================================================
      dist
      
      Defines the default distribution process
      ====================================================================-->
  <target name="dist" depends="jar, gwt-package" description="Creates distribution including GWT output" />


  <!--=======================================================================
      gwt-package
      
      Packages the GWT output
      ====================================================================-->
  <target name="gwt-package" depends="gwt-compile" description="Packages the GWT output">
    <zip destfile="${dist.dir}/${gwt.artifact.id}-${project.revision}.zip" basedir="${gwt.output.dir}" compress="true">
      <exclude name=".gwt-tmp/" />
      <exclude name="*-aux/" />
    </zip>
  </target>


  <!--=======================================================================
      install-gwt-dev
      
      Downloads and installs gwt-dev jars and native libraries
      ====================================================================-->
  <target name="install-gwt-dev" depends="gwt-dev.download" description="Installs gwt-dev jar and native libraries">
    <unzip src="${gwt-dev.zipfile}" dest="${devlib.dir}" />
    <delete file="${gwt-dev.zipfile}" />

    <echo>
      *************************************************************************************************
      ** Gwt dev files have been installed to ${devlib.dir}.
      ** Make sure ${gwt-dev.jarfile} 
      ** appears before other jars in your IDE's classpath, 
      ** otherwise running in hosted mode may fail.
      *************************************************************************************************
    </echo>
  </target>


  <!--=======================================================================
      gwt-dev.download
      
      Downloads GWT dev libraries if they don't already exist
      ====================================================================-->
  <target name="gwt-dev.download" depends="install-ivy,init">
    <condition property="maven.classifier" value="windows">
      <isset property="isWindows" />
    </condition>
    <condition property="maven.classifier" value="linux">
      <isset property="isLinux" />
    </condition>
    <condition property="maven.classifier" value="mac">
      <isset property="isMac" />
    </condition>

    <get src="http://repo1.maven.org/maven2/com/google/gwt/gwt-dev/1.5.2/gwt-dev-${gwt-dev.revision}-${maven.classifier}-libs.zip"
         dest="${gwt-dev.zipfile}" />
    <get src="http://repo1.maven.org/maven2/com/google/gwt/gwt-dev/1.5.2/gwt-dev-${gwt-dev.revision}-${maven.classifier}.jar"
         dest="${gwt-dev.jarfile}" />
  </target>

</project>